package main

import (
	"os"
	"strings"
	"testing"

	"github.com/vulncheck-oss/go-exploit/db"
)

func TestConfluenceShodanGZIP(t *testing.T) {
	dbName := "./test/test.db"
	db.GlobalHTTPRespCacheLimit = 1000000
	if !db.InitializeDB(dbName) {
		t.Error("Failed to create the db")
	}
	defer os.Remove(dbName)

	if !DoShodanGZIP("test/testdata/shodan-confluence.json.gz") {
		t.Error("Failed parsing of the shodan gzip")
	}
	request, lookupOK := db.GetHTTPResponse("52.200.210.54", 80, "/")
	if !lookupOK {
		t.Error("Failed DB lookup")
	}
	if !strings.HasPrefix(request, "HTTP/1.1 200") {
		t.Error("Failed to resolve '/'")
	}
	if !strings.Contains(request, "X-Confluence-Request-Time") {
		t.Error("Failed to extract the right header for '/'")
	}
	if !strings.Contains(request, "confluence-context-path") {
		t.Error("Failed to extract the right header for '/'")
	}
}
